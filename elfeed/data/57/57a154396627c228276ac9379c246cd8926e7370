<p>Thanks to Susan Ferrell,&nbsp;Senior Technical Writer, for a great blog post on how to use CodeCommit branch-level permissions.<br /> —-</p> 
<p>AWS CodeCommit users have been asking for a way to restrict commits to some repository branches to just a few people. In this blog post, we’re going to show you how to do that by creating and applying a <em>conditional policy</em>, an <a href="https://aws.amazon.com/iam/">AWS Identity and Access Management</a> (IAM) policy that contains a context key.</p> 
<h2>Why would I do this?</h2> 
<p>When you create a branch in an <a href="https://aws.amazon.com/codecommit/">AWS CodeCommit</a> repository, the branch is available, by default, to all repository users. Here are some scenarios in which refining access might help you:</p> 
<ul> 
 <li>You maintain a branch in a repository for production-ready code, and you don’t want to allow changes to this branch except from a select group of people.</li> 
 <li>You want to limit the number of people who can make changes to the default branch in a repository.</li> 
 <li>You want to ensure that pull requests cannot be merged to a branch except by an approved group of developers.</li> 
</ul> 
<p>We’ll show you how to create a policy in IAM that prevents users from pushing commits to and merging pull requests to a branch named <strong>master</strong>. You’ll attach that policy to one group or role in IAM, and then test how users in that group are affected when that policy is applied. We’ll explain how it works, so you can create custom policies for your repositories.</p> 
<h2>What you need to get started</h2> 
<ul> 
 <li>You’ll need to sign in to AWS with sufficient permissions to: 
  <ul> 
   <li style="list-style-type: none"> 
    <ul> 
     <li>Create and apply policies in IAM.</li> 
     <li>Create groups in IAM.</li> 
     <li>Add users to those groups.</li> 
     <li>Apply policies to those groups.</li> 
    </ul> </li> 
  </ul> <p>You can use existing IAM groups, but because you’re going to be changing permissions, you might want to first test this out on groups and users you’ve created specifically for this purpose.</p></li> 
 <li>You’ll need a repository in AWS CodeCommit with at least two branches: <strong>master</strong> and <strong>test-branch</strong>. For information about how to create repositories, see <a href="https://docs.aws.amazon.com/codecommit/latest/userguide/how-to-create-repository.html">Create a Repository</a>. For information about how to create branches, see <a href="https://docs.aws.amazon.com/codecommit/latest/userguide/how-to-create-branch.html">Create a Branch</a>. In this blog post, we’ve named the repository MyDemoRepo. You can use an existing repository with branches of another name, if you prefer.</li> 
</ul> 
<p>Let’s get started!</p> 
<h2>Create two groups in IAM</h2> 
<p>We’re going to set up two groups in IAM: Developers and Senior_Developers. To start, both groups will have the same managed policy, <strong>AWSCodeCommitPowerUsers</strong>, applied. Users in each group will have exactly the same permissions to perform actions in IAM.</p> 
<p><img class="alignnone size-full wp-image-2381" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2018/05/04/branch-policy1.png" alt="" width="797" height="350" /></p> 
<p><em>Figure 1: Two example groups in IAM, with distinct users but the same managed policy applied to each group</em></p> 
<p>First, create the Developers group.</p> 
<ol> 
 <li>Sign in to the AWS Management Console and open the IAM console at <a href="https://console.aws.amazon.com/iam/">https://console.aws.amazon.com/iam/</a>.</li> 
 <li>In the navigation pane, choose <strong>Groups</strong>, and then choose <strong>Create New Group</strong>.</li> 
 <li>In the <strong>Group Name</strong> box, type <strong>Developers</strong>, and then choose <strong>Next Step</strong>.</li> 
 <li>In the list of policies, select the check box for <strong>AWSCodeCommitPowerUsers</strong>, then choose <strong>Next Step</strong>.</li> 
 <li>Choose <strong>Create Group</strong>.</li> 
</ol> 
<p>Now, follow these steps to create the Senior_Developers group and attach the <strong>AWSCodeCommitPowerUsers</strong> managed policy. You now have two empty groups with the same policy attached.</p> 
<h2>Create users in IAM</h2> 
<p>Next, add at least one unique user to each group. You can use existing IAM users, but because you’ll be affecting their access to AWS CodeCommit, you might want to create two users just for testing purposes. Let’s go ahead and create Arnav and Mary.</p> 
<ol> 
 <li>In the navigation pane, choose <strong>Users</strong>, and then choose <strong>Add user</strong>.</li> 
 <li>For the new user, type Arnav_Desai.</li> 
 <li>Choose <strong>Add another user</strong>, and then type Mary_Major.</li> 
 <li>Select the type of access (programmatic access, access to the AWS Management Console, or both). In this blog post, we’ll be testing everything from the console, but if you want to test AWS CodeCommit using the AWS CLI, make sure you include programmatic access and console access.</li> 
 <li>For <strong>Console password type</strong>, choose <strong>Custom password</strong>. Each user is assigned the password that you type in the box. Write these down so you don’t forget them. You’ll need to sign in to the console using each of these accounts.</li> 
 <li>Choose <strong>Next: Permissions</strong>.</li> 
 <li>On the <strong>Set permissions</strong> page, choose <strong>Add user to group</strong>. Add Arnav to the Developers group. Add Mary to the Senior_Developers group.</li> 
 <li>Choose <strong>Next: Review</strong> to see all of the choices you made up to this point. When you are ready to proceed, choose <strong>Create user</strong>.</li> 
</ol> 
<p>Sign in as Arnav, and then follow these steps to go to the <strong>master</strong> branch and add a file. Then sign in as Mary and follow the same steps.</p> 
<ol> 
 <li>Open the AWS CodeCommit console at <a href="https://console.aws.amazon.com/codecommit">https://console.aws.amazon.com/codecommit</a>.</li> 
 <li>On the <strong>Dashboard</strong> page, from the list of repositories, choose <strong>MyDemoRepo</strong>.</li> 
 <li>In the <strong>Code</strong> view, choose the branch named <strong>master</strong>.</li> 
 <li>Choose <strong>Add file</strong>, and then choose <strong>Create file</strong>. Type some text or code in the editor.</li> 
 <li>Provide information to other users about who added this file to the repository and why. 
  <ol> 
   <li>In <strong>Author name</strong>, type the name of the user (Arnav or Mary).</li> 
   <li>In <strong>Email address</strong>, type an email address so that other repository users can contact you about this change.</li> 
   <li>In <strong>Commit message</strong>, type a brief description to help you remember why you added this file or any other details you might find helpful.</li> 
   <li>Type a name for the file.</li> 
  </ol> </li> 
 <li>Choose Commit file.</li> 
</ol> 
<p>Now follow the same steps to add a file in a different branch. (In our example repository, that’s the branch named <strong>test-branch</strong>.) You should be able to add a file to both branches regardless of whether you’re signed in as Arnav or Mary.</p> 
<p>Let’s change that.</p> 
<h2>Create a conditional policy in IAM</h2> 
<p>You’re going to create a policy in IAM that will deny API actions if certain conditions are met. We want to prevent users with this policy applied from updating a branch named <strong>master</strong>, but we don’t want to prevent them from viewing the branch, cloning the repository, or creating pull requests that will merge to that branch. For this reason, we want to pick and choose our APIs carefully. Looking at the <a href="https://docs.aws.amazon.com/codecommit/latest/userguide/auth-and-access-control-permissions-reference.html">Permissions Reference</a>, the logical permissions for this are:</p> 
<ul> 
 <li>GitPush</li> 
 <li>PutFile</li> 
 <li>MergePullRequestByFastForward</li> 
</ul> 
<p>Now’s the time to think about what else you might want this policy to do. For example, because we don’t want users with this policy to make changes to this branch, we probably don’t want them to be able to delete it either, right? So let’s add one more permission:</p> 
<ul> 
 <li>DeleteBranch</li> 
</ul> 
<p>The branch in which we want to deny these actions is <strong>master</strong>. The repository in which the branch resides is <em>MyDemoRepo</em>. We’re going to need more than just the repository name, though. We need the repository ARN. Fortunately, that’s easy to find. Just go to the AWS CodeCommit console, choose the repository, and choose <strong>Settings</strong>. The repository ARN is displayed on the <strong>General</strong> tab.</p> 
<p>Now we’re ready to create a policy.<br /> 1. Open the IAM console at <a href="https://console.aws.amazon.com/iam/">https://console.aws.amazon.com/iam/</a>. Make sure you’re signed in with the account that has sufficient permissions to create policies, and not as Arnav or Mary.<br /> 2. In the navigation pane, choose Policies, and then choose Create policy.<br /> 3. Choose JSON, and then paste in the following:</p> 
<pre><code class="lang-json">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Deny&quot;,
            &quot;Action&quot;: [
                &quot;codecommit:GitPush&quot;,
                &quot;codecommit:DeleteBranch&quot;,
                &quot;codecommit:PutFile&quot;,
                &quot;codecommit:MergePullRequestByFastForward&quot;
            ],
            &quot;Resource&quot;: &quot;<span style="color: #ff0000">arn:aws:codecommit:us-east-2:80398EXAMPLE:MyDemoRepo</span>&quot;,
            &quot;Condition&quot;: {
                &quot;StringEqualsIfExists&quot;: {
                    &quot;codecommit:References&quot;: [
                        &quot;refs/heads/<span style="color: #ff0000">master</span>&quot;   
                    ]
                },
                &quot;Null&quot;: {
                    &quot;codecommit:References&quot;: false
                }
            }
        }
    ]
}
</code></pre> 
<p>You’ll notice a few things here. First, change the repository ARN to the ARN for your repository and include the repository name. Second, if you want to restrict access to a branch with a name different from our example, <strong>master</strong>, change that reference too.</p> 
<p>Now let’s talk about this policy and what it does. You might be wondering why we’re using a Git reference (refs/heads) value instead of just the branch name. The answer lies in how Git references things, and how AWS CodeCommit, as a Git-based repository service, implements its APIs. A branch in Git is a simple pointer (reference) to the SHA-1 value of the head commit for that branch.</p> 
<p>You might also be wondering about the second part of the condition, the nullification language. This is necessary because of the way <code>git push</code> and <code>git-receive-pack</code> work. Without going into too many technical details, when you attempt to push a change from a local repo to AWS CodeCommit, an initial reference call is made to AWS CodeCommit without any branch information. AWS CodeCommit evaluates that initial call to ensure that:</p> 
<p>a) You’re authorized to make calls.</p> 
<p>b) A repository exists with the name specified in the initial call. If you left that null out of the policy, users with that policy would be unable to complete any pushes from their local repos to the AWS CodeCommit remote repository at all, regardless of which branch they were trying to push their commits to.</p> 
<p>Could you write a policy in such a way that the null is not required? Of course. IAM policy language is flexible. There’s an example of how to do this in the <a href="https://docs.aws.amazon.com/codecommit/latest/userguide/auth-and-access-control-iam-identity-based-access-control.html#customer-managed-policies">AWS CodeCommit User Guide</a>, if you’re curious. But for the purposes of this blog post, let’s continue with this policy as written.</p> 
<p>So what have we essentially said in this policy? We’ve asked IAM to deny the relevant CodeCommit permissions if the request is made to the resource <em>MyDemoRepo</em> and it meets the following condition: the reference is to refs/heads/master. Otherwise, the deny does not apply.</p> 
<p>I’m sure you’re wondering if this policy has to be constrained to a specific repository resource like <em>MyDemoRepo</em>. After all, it would be awfully convenient if a single policy could apply to all branches in any repository in an AWS account, particularly since the default branch in any repository is initially the <strong>master</strong> branch. Good news! Simply replace the ARN with an *, and your policy will affect ALL branches named <strong>master</strong> in every AWS CodeCommit repository in your AWS account. Make sure that this is really what you want, though. We suggest you start by limiting the scope to just one repository, and then changing things when you’ve tested it and are happy with how it works.</p> 
<p>When you’re sure you’ve modified the policy for your environment, choose <strong>Review policy</strong> to validate it. Give this policy a name, such as <strong>DenyChangesToMaster</strong>, provide a description of its purpose, and then choose <strong>Create policy</strong>.</p> 
<p>Now that you have a policy, it’s time to apply and test it.</p> 
<h2>Apply the policy to a group</h2> 
<p>In theory, you could apply the policy you just created directly to any IAM user, but that really doesn’t scale well. You should apply this policy to a group, if you use IAM groups to manage users, or to a role, if your users assume a role when interacting with AWS resources.</p> 
<ol> 
 <li>In the IAM console, choose <strong>Groups</strong>, and then choose <strong>Developers</strong>.</li> 
 <li>On the <strong>Permissions</strong> tab, choose <strong>Attach Policy</strong>.</li> 
 <li>Choose <strong>DenyChangesToMaster</strong>, and then choose <strong>Attach policy</strong>.</li> 
</ol> 
<p>Your groups now have a critical difference: users in the <strong>Developers</strong> group have an additional policy applied that restricts their actions in the <strong>master</strong> branch. In other words, Mary can continue to add files, push commits, and merge pull requests in the <strong>master</strong> branch, but Arnav cannot.</p> 
<p><img class="alignnone size-full wp-image-2382" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2018/05/04/branch-policy2.png" alt="" width="797" height="402" /></p> 
<p><em>Figure 2: Two example groups in IAM, one with an additional policy applied that will prevent users in this group from making changes to the master branch</em></p> 
<p>Test it out. Sign in as Arnav, and do the following:</p> 
<ol> 
 <li>Open the AWS CodeCommit console at <a href="https://console.aws.amazon.com/codecommit">https://console.aws.amazon.com/codecommit</a>.</li> 
 <li>On the <strong>Dashboard</strong> page, from the list of repositories, choose <strong>MyDemoRepo</strong>.</li> 
 <li>In the <strong>Code</strong> view, choose the branch named <strong>master</strong>.</li> 
 <li>Choose <strong>Add file</strong>, and then choose <strong>Create file</strong>, just as you did before. Provide some text, and then add the file name and your user information.</li> 
 <li>Choose <strong>Commit file</strong>.</li> 
</ol> 
<p>This time you’ll see an error after choosing <strong>Commit file</strong>. It’s not a pretty message, but at the very end, you’ll see a telling phrase: “explicit deny”. That’s the policy in action. You, as Arnav, are explicitly denied PutFile, which prevents you from adding a file to the <strong>master</strong> branch. You’ll see similar results if you try other actions denied by that policy, such as deleting the <strong>master</strong> branch.</p> 
<p>Stay signed in as Arnav, but this time add a file to <strong>test-branch</strong>. You should be able to add a file without seeing any errors. You can create a branch based on the <strong>master</strong> branch, add a file to it, and create a pull request that will merge to the <strong>master</strong> branch, all just as before. However, you cannot perform denied actions on that master branch.</p> 
<p>Sign out as Arnav and sign in as Mary. You’ll see that as that IAM user, you can add and edit files in the <strong>master</strong> branch, merge pull requests to it, and even, although we don’t recommend this, delete it.</p> 
<h2>Conclusion</h2> 
<p>You can use conditional statements in policies in IAM to refine how users interact with your AWS CodeCommit repositories. This blog post showed how to use such a policy to prevent users from making changes to a branch named <strong>master</strong>. There are many other options. We hope this blog post will encourage you to experiment with AWS CodeCommit, IAM policies, and permissions. If you have any questions or suggestions, we’d love to hear from you.</p>